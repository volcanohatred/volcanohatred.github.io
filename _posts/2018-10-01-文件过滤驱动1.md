---
layout:     post
title:      文件过滤驱动(一)
subtitle:   Sfilter
date:       2018-10-01
author:     volcanohatred
header-img: img/articles/文件过滤驱动/title.jpg
catalog: true
tags:
    - 内核
    - windows
    - 系统安全
    - 驱动
---
### 文件系统过滤驱动
#### 过滤
分层驱动中再加一层而不影响上下层，以过滤他们之间的数据，对数据进行安全控制。
IRP分头部和栈，应用层的命令和数据通过I/O管理器封装在IRP中然后逐层发给下层驱动创建的设备对象进行处理。
![文件过滤](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/文件过滤驱动/1/图片1.png)  
Sfilter诞生于很早之前。快要被淘汰，但是了解Sfilter对于整个文件驱动框架的理解很是关键。
#### 绑定
**控制设备**  
生成的设备对象专门和用户自己的客户端进行通讯  
**过滤设备**  
生成的设备对象绑定到其他设备之上，接受其他R3  
驱动自己生成一个设备，调用系统提供的API，绑定到目标设备上，并返回一个在未绑定之前目标设备所在设备栈的最顶层设备。  
绑定API:  
```
IoAttachDevice()
IoAttachDeviceToDeviceStackSafe()
IoAttachDeviceToDeviceStack()
```  
返回未绑定之前目标设备所在设备栈的最顶层设备是用于IRP下发，并将返回的设备对象保存在目标设备的设备扩展里面。  
设备对象结构体DEVICE_OBJECT  
```
typedef struct DECLSPEC_ALIGN(MEMORY_ALLOCATION_ALIGNMENT) _DEVICE_OBJECT
{
    CSHORT Type;
    USHORT Size;
    LONG ReferenceCount;
    /*指向驱动程序中驱动对象的指针*/
    struct _DRIVER_OBJECT *DriverObject;
    /*指向下一个设备对象的指针*/
    struct _DEVICE_OBJECT *NextDevice;
    /*上一个设备对象的指针*/
    struct _DEVICE_OBJECT *AttachedDevice;
    /*当前IRP结构*/
    struct _IRP *CurrentIrp;
    PIO_TIMER Timer;
    /*设备对象的特性标志*/
    ULONG Flags;
    ULONG Characteristics;
    _volatile PVPB Vpb;
    /*指向设备扩展对象的指针*/
    PVOID DeviceExtension;
    /*指明设备类型*/
    DEVICE_TYPE DeviceType;
    /*堆栈的最小层数*/
    CCHAR StackSize;
    union {
        LIST_ENTRY ListEntry;
        WAIT_CONTEXT_BLOCK Wcb;
    } Queue;
    /*内存对齐*/
    ULONG AlignmentRequirement;
    KDEVICE_QUEUE DeviceQueue;
    KDPC Dpc;
    /*
    *下列成员用于支持文件系统的互斥操作
    *以便对文件系统处理线程使用设备的计数保持跟踪
    */
    ULONG ActiveThreadCount;
    PSECURITY_DESCRIPTOR SecurityDescriptor;
    KEVENT DeviceLock;
 
    USHORT SectorSize;
    USHORT Spare1;
 
    struct _DEVOBJ_EXTENSION  *DeviceObjectExtension;
    PVOID  Reserved;
 
} DEVICE_OBJECT;
typedef struct _DEVICE_OBJECT *PDEVICE_OBJECT;
```  
Sfilter框架已经将绑定等处理好了，用户只需要进行的操作是对拿到的数据进行处理。  