---
layout:     post
title:      一次曲折的web渗透
subtitle:   
date:       2018-10-09
author:     volcanohatred
header-img: img/articles/一次曲折的web渗透/title.jpg
catalog: true
tags:
    - web渗透
    - 内网渗透
    - 渗透测试
---

## 1.踏上征程
最近接到了一个项目，是对一个学校的会议网站进行渗透测试。刚好闲的没事就看看。当然我是抱着拿服务器的权限去的，不单单是为了发现漏洞。嘿嘿
正常操作，正规的测试流程，经过对目标站点的初步测试，并没有发现问题：注入有专门的防注入系统，并且目标服务器最外层有waf，提交的特殊参数直接连接重置。会议可以注册用户，注册用户上传文件的地方是白名单，而且并没有上传漏洞，编辑器是ewebeditor，版本是2.8，在5654vbfdw目录下，默认密码修改，数据库没法下载。  
![1](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片1.png)  
目标web服务器大致网络位置：  
![43](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片43.png)  
就目前收集的信息所知，这个网站有5个管理系统，会议注册用户后台（只要注册就可以进入，并没发现问题），会议发布管理员后台，网站管理员后台，财务审核管理员后台以及sms短信服务平台。
会议发布管理员登陆和财务审核管理员登陆需要sso认证，其他需要账号密码登陆，因为甲方给了测试账号，所以先看看这个有没有漏洞。用给的测试账号t201710登陆进去看看：  
![2](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片2.png)
![3](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片3.png)  
尼玛，啥权限没有，什么都干不了，那给的测试账号有什么价值？只能看看其他地方了。看看与sso交互的地方有什么问题。经过测试分析，网站sso登陆流程如下：  
![46](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片46.png)  
用户登陆login.asp,跳转到sso服务器进行身份验证，验证成功后sso返回有效票据ticket给login.asp,login.asp识别有票据后，会将票据发至sso查询用户名uid，查到uid后，sso将uid返回给userlogin.asp完成登陆。因为uid是明文的，所以可以直接抓包改包方可伪造任意管理员进行访问，此处存在逻辑漏洞，越权访问，在此sso就显得很鸡肋了。
验证：  
![4](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片4.png)
![5](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片5.png)
![6](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片6.png)
![7](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片7.png)
![8](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片8.png)
![9](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片9.png)
![10](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片10.png)  
既然构造uid能越权访问，那拿到intruder里面去跑查看返回值就行了，据我所知，会议管理都是老师的教师号，老师的教师号应该是10位，如果固定以19开头那就是8位，也得跑一亿种可能，跑了一晚上一百万都没跑到，算了，时间成本太高，想想其他办法。
现在转过头去看看编辑器，编辑器虽然没漏洞，但总觉得5654vbfdw这个目录有点奇怪，试试谷歌语法：  
![11](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片11.png)  
inurl:5654vbfdw和intext：5654vbfdw  
![12](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片12.png)  
结果出乎意料，很多站点都有这个目录而且5654vbfdw里面是ewebeditor编辑器，这说明两种可能:  
1.ewebeditor编辑器是某个网站下载的。  
2.是某个网站开发公司做的模板。  
无论怎么说，都有找到源代码的价值。经过对这些网站的翻阅，发现都是会议相关的，这不是巧合，所以我觉得第二种可能性比较大，在这些网站页尾看看有没有什么信息。果真他们都指向了同一个公司：  
![13](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片13.png)
![14](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片14.png)
![15](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片15.png)  
这里可以在线体验，我假装自己是某某大学网信中心的老师，想体验一下他们的会议管理后台并索要密码，顺便看看他们能不能给个源代码啥的（哈哈，想多了）。  
![16](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片16.png)
![17](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片17.png)  
进入体验版后台：  
![18](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片18.png)
![19](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片19.png)  
翻阅的时候意外发现他们体验版会议设置的smtp服务数据框密码不是自绘的，竟然是真实邮箱密码，尝试登陆163，成功登陆，发现了甲方当时搭建网站时候的测试账号，很意外，用这个账号回过头去登陆会议网，结果成功进入后台：  
![20](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片20.png)
![21](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片21.png)
![22](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片22.png)  
这个后台权限就比较大了，可以修改已经发布了的会议。试着构造了会议名称等等，结果发现存在xss。本来想用xss打打管理员cookies进入管理员后台，结果发现构造的语句影响的是首页，而且插入到会议名称里面虽然执行了，但是会议名称字体大小和其他会议不一样，怕引起管理员的注意，当然也影响了甲方网站的正常使用，所以这个思路又泡汤了。另一个思路试试能不能配置文件插马，在会议名称和一些数据输入的地方写入一句话，看看能不能写到配置文件中。结果发现行不通，因为菜刀连接直接被waf识别然后重置连接。也无法验证是写到哪里去了（后来看了源代码发现提交的所有数据都写在数据库里了，配置文件里面只是数据库连接方式及密码。）这个思路又行不通。  
![23](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片23.png)
换个思路，看看财务审核那个系统有没有问题，用拿到的管理员账号配合逻辑漏洞，进去后发现没什么问题，上传做了白名单，注入不可能。再回过头去看看防注入系统，看他们用的什么模块，找打了他们的防注入后台，默认密码admin已经修改，也是不行。现在为止所有的思路都断了。  
![24](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片24.png)  
## 2.重头再来
虽然没了思路，但我觉得这个网站肯定是有问题，这么多拼接的模块和功能，我就不信没什么毛病。冷静下来想想，觉得应该对网站目录进行重新的信息收集，当时只是收集了大概的一些信息，尤其是sms短信平台，没有仔细的进行目录扫描。那现在回过头再看看，之前用AWVS已经爬过目录了，所以就直接放到御剑里面爆破吧，这里说明一下，御剑的扫描技巧：一定要打开403和3xx，这样是为了为下一步的递归扫描做准备，何为递归扫描？就是比如你扫一个xx.com的网站，肯定先扫根目录吧，扫完根目录然后得到这些目录（假如）：  
```
xx.com/1
xx.com/2
xx.com/3
```  
然后拿到这些目录再扫他们的子目录得到下一层目录：  
```
xx.com/1/1
Xx.com/1/2
```  
一次类推，这样基本上对他们所有的目录都有一个比较全面的认识。  
![25](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片25.png)
所以，一定要打开403和3xx，防止一些目录被遗忘。
经过这一次的细致扫描，发现了不可思议的东西，sms目录里面还有一个ewebeditor：  
![26](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片26.png)  
而且默认用户密码没改，但是样式管理被阉割了。但是存在目录遍历漏洞可以遍历编辑器目录，看到数据库文件名，结果下载不下来。
继续扫描。发现了一个大马。。。。  
![27](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片27.png)  
是的，大马没错，看了下创建日期，应该是当时开发公司提交过来就有的，真是很意外，看了下基本信息：  
![28](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片28.png)
![29](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片29.png)  
普通权限，需要提权。但是可以连接外网，这一点还是可以的，但是接下来就让人有点难受，文件没法上传，直接重置，又是该死的防火墙。啊啊啊啊啊。  
![30](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片30.png)  
换个思路，既然有大马了，看看配置文件,拿到数据库密码，连下数据库（sql server）看看数据库什么权限：  
![31](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片31.png)
![32](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片32.png)  
数据库用户sa被禁用，allconfs这个用户权限很低，没什么用。去看看admin表，看看能不能拿到密码进去网站管理后台，结果密码这样的：  
![33](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片33.png)  
自定义的加密函数，找找解密方法吧：在admin目录下找到了chklogin.asp里面找到了加密和解密函数，那就直接用吧：  
![34](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片34.png)  
写个脚本跑了下，成功拿到密码进入后台：  
![35](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片35.png)  
结果没什么用，感觉这和其他几个系统一个处理代码，没什么漏洞。
现在思路又没了，想提权就得上传exp，但是一有上传就重置，真的让人没有办法。
## 3.另辟蹊径
各种方法都试了，虽然拿到了webshell，但是离我的出发点还很远，而且一直绕不过waf，整个人都魔怔了。一天晚上咬咬牙，想了下，不行就c段吧，管他什么协议（危险行为，请勿模仿）。  
思路又来了：拿到c段一台服务器高权限的webshell，只要权限够高，可以添加用户拿到3389，端口转发就ok，进了内网就没waf了。  
说干就干！扫c段！  
因为c段服务器真的很多，所以优先找jsp的站点和和目标站点在同一子网里的服务器下手（jsp一般权限比较大），从刚才大马收集到的信息来看，这个c段是等长子网划分的，而且目标服务器在xx.xx.xx.1-126这个网段,所以就从这个网段入手，经过一番渗透测试，终于拿到了xx.xx.xx.33这台服务器（通过编辑器漏洞），在渗透这台服务器的时候，因为有waf，所以一些敏感字段都被过滤或者拦截，，到最后只上传了一个能执行系统命令的一句话jsp脚本。但是不碍事。  
![36](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片36.png)
![37](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片37.png)
![37](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片38.png)  
经过对这台服务器的信息收集可以看出，这台服务器是系统权限，且没开360等一些杀软，很好！唯一不足之处就是无法连接外网，但这都是无所谓的。服务器开了3389和1433，3389路由做了acl策略，外网扫不到，1433数据库可以连接，权限为sa权限。现在有两种选择  
1. 端口转发：因为通过mssql创建表和数据流可以上传文件，所以可以上传端口转发工具或者反弹shell，但是因为不能连接外网。所以lck或者反弹shell并不能有效，这种情况可以使用windows自带的工具netsh（需管理员权限）（注：netsh真的是个神器，在能做的操作有限的情况下实现端口转发）：  
```
xx.jsp/UserFiles/File/1/cmd2.jsp?pwd=admin&cmd=netsh interface portproxy add v4tov4 listenaddress=ip listenport=6666 connectaddress=ip connectport=3389
```  
将3389到映射到其他端口，然后外网进行连接。有时需要安装ipv6（windows server2003和xp）和关闭防火墙：  
```
netsh interface ipv6 install
netsh firewall set opmode disable
```  
这样就可以实现外网连接3389了。  
2. 改3389端口
因为是sa用户，可以通过xp_regwrite操纵注册表修改3389端口：  
```
master.dbo.xp_regwrite'HKEY_LOCAL_MACHINE','SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp','PortNumber','REG_DWORD',6666;
master.dbo.xp_regwrite'HKEY_LOCAL_MACHINE','SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp','PortNumber','REG_DWORD',6666;
```  
斟酌了下，觉得还是选用第一种方法，第二种方法需要重启服务器，导致正常服务收到影响。而第一种方法既方便又可以做到神不知鬼不觉。这样，成功进入内网，并且用菜刀连接了之前尝试的配置文件插马，结果发现并没写在配置文件中。  
此处需要注意连接3389之后共享自己的磁盘，将一些常用工具放到该磁盘中，要想运行工具，直接点击运行自己磁盘的工具就行，这样可以逃避杀软的流量检测和磁盘检测。    
![39](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片39.png)  
现在已经拿到内网权限了，就从这台服务器连接大马，上传提权exp，因为目标主机能访问外网，所以为了方便传了一个msf生成的加壳木马，外网连接：  
![40](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片40.png)  
成功获取会话，下面就很简单了，看看服务器有啥补丁没打，提权就行了，最后用ms16075提权成功，获取到系统权限，搞定！！！  
16075提权语句：  
```
use incognito
list_tokens -u
execute -cH -f 16075exp绝对路径
impersonate_token “NT AUTHORITY\\SYSTEM” 
```   
![41](https://raw.githubusercontent.com/volcanohatred/volcanohatred.github.io/master/img/articles/一次曲折的web渗透/图片41.png)
